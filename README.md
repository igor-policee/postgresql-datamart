# Витрина данных для RFM-классификации пользователей приложения

RFM (от англ. Recency Frequency Monetary Value) — способ сегментации клиентов, при котором анализируют их лояльность: как часто, на какие суммы и когда в последний раз тот или иной клиент покупал что-то. На основе этого выбирают клиентские категории, на которые стоит направить маркетинговые усилия.
Каждого клиента оценивают по трём факторам:
- Recency (пер. «давность») — сколько времени прошло с момента последнего заказа.
- Frequency (пер. «частота») — количество заказов.
- Monetary Value (пер. «денежная ценность») — сумма затрат клиента.

## Описание целевой витрины и входных данных

> [Требования к целевой витрине](requirements.md)

> [Качество входных данных](data_quality.md)

## Подготовка витрины

### Представление для таблиц из схемы `production` в схеме `analysis`

При расчете витрины будем обращаться только к объектам из схемы `analysis`. 
Чтобы не дублировать данные (данные находятся в этой же базе), сделаем представления, которые отображают данные из схемы `production` в схему `analysis`.

> [SQL для создания представлений](src/views.sql) 

### Создание целевой витрины `analysis.dm_rfm_segments`

> [SQL для создания витрины](src/datamart_ddl.sql)

### Заполнение витрины

> [SQL для расчета, создания и заполнения таблицы Recency](src/tmp_rfm_recency.sql)

> [SQL для расчета, создания и заполнения таблицы Frequency](src/tmp_rfm_frequency.sql)

> [SQL для расчета, создания и заполнения таблицы Monetary Value](src/tmp_rfm_monetary_value.sql)

> [SQL для объединения показателей и заполнения целевой витрины](src/datamart_query.sql)

## Доработка представлений

Разработчики приложения обновили структуру данных в схеме `de.production`. 
В таблице `production.orders` больше нет поля статуса, а это поле необходимо для фильтра заказов со статусом `«Closed»`.
Вместо этого в базу была добавлена таблица для журналирования всех изменений статусов заказов — `production.orderstatuslog`.

Структура таблицы:
- `id` — синтетический автогенерируемый идентификатор записи.
- `order_id` — идентификатор заказа, внешний ключ на таблицу `production.orders`.
- `status_id` — идентификатор статуса, внешний ключ на таблицу `production.orderstatuses`.
- `dttm` — дата и время получения заказом этого статуса.

Чтобы скрипт по расчёту витрины продолжил работать, необходимо внести изменения в логику формирования представления `analysis.orders`, а именно вернуть в него поле `status`. 
Значение в этом поле должно соответствовать последнему по времени статусу из таблицы `production.orderstatuslog`.

> [SQL для обновления логики формирования представления](src/orders_view.sql)
